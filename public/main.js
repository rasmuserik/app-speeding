// Generated by CoffeeScript 1.6.1
(function() {
  var addBar, addHover, addTitle, avg, barSpacing, barWidth, barX, barY, danishDate, getData, hideHover, hoverDepth, lineHeight, millisecondsPerDay, millisecondsPerHour, showHover, speedLimit, unitIds, visualiseBars, visualiseScore, webservice;

  webservice = "/webservice";

  speedLimit = 50;

  unitIds = {
    37: "Motorring 4",
    101: "Kolding V",
    111: "Vilsundbroen"
  };

  barWidth = 100;

  barX = 100;

  barY = 7;

  barSpacing = 220;

  lineHeight = 16;

  danishDate = function(date) {
    return "" + (date.getDate()) + "/" + (date.getMonth() + 1) + "-" + (date.getFullYear());
  };

  millisecondsPerHour = 60 * 60 * 1000;

  millisecondsPerDay = 24 * millisecondsPerHour;

  avg = function(list) {
    return list.reduce((function(a, b) {
      return a + b;
    }), 0) / list.length;
  };

  getData = function(callback) {
    return Meteor.call("getData", callback);
  };

  this.visSpeed = function(obj) {
    return $.get(obj.webservice, (function(result) {
      if (obj.visualisationElem) {
        visualiseBars($(obj.visualisationElem), result);
      }
      if (obj.scoreElem) {
        return visualiseScore($(obj.scoreElem), result);
      }
    }), "json");
  };

  visualiseScore = function($score, data) {
    return void 0;
  };

  visualiseBars = function($visualisation, data) {
    var datahour, datehour, datehours, id, key, x, y, _i, _len, _results;
    datehours = {};
    for (id in unitIds) {
      for (datahour in data[id]) {
        datehours[datahour] = true;
      }
    }
    datehours = ((function() {
      var _results;
      _results = [];
      for (key in datehours) {
        _results.push(key);
      }
      return _results;
    })()).sort().reverse();
    console.log(data, datehours);
    y = 0;
    _results = [];
    for (_i = 0, _len = datehours.length; _i < _len; _i++) {
      datehour = datehours[_i];
      addTitle($visualisation, datehour, 0, y);
      x = barX;
      for (id in unitIds) {
        console.log(data[id][datehour]);
        addBar($visualisation, data[id][datehour], x, y);
        x += barSpacing;
      }
      _results.push(y += lineHeight);
    }
    return _results;
  };

  addTitle = function($root, title, x, y) {
    var $label, date, text;
    text = title.slice(-2) + ":00";
    date = " " + title.slice(5, -3);
    if (y === 0) {
      text = text + date;
    }
    if (text === "23:00") {
      text = text + date;
    }
    $label = ($('<div class="label">')).text(text);
    $label.css({
      left: x,
      top: y
    });
    return $root.append($label);
  };

  addBar = function($root, item, x, y) {
    var $avgLine, $blueBox, $orangeBox;
    console.log(item);
    $blueBox = $('<div class="bar ok">');
    $blueBox.css({
      left: x + item.offenders * barWidth,
      top: y + barY,
      width: barWidth * (1 - item.offenders)
    });
    $root.append($blueBox);
    $orangeBox = $('<div class="bar offenders">');
    $orangeBox.css({
      left: x + barWidth,
      top: y + barY,
      width: barWidth * item.offenders
    });
    $root.append($orangeBox);
    $avgLine = $('<div class="speedLine">');
    $avgLine.css({
      left: x + item.avgSpeed / speedLimit * barWidth,
      top: y + barY
    });
    $root.append($avgLine);
    return addHover($root, item, [$blueBox, $orangeBox, $avgLine]);
  };

  hoverDepth = 0;

  showHover = function(item) {
    return console.log("showhover");
  };

  hideHover = function(item) {
    return console.log("hidehover");
  };

  addHover = function($root, item, elems) {
    var $elem, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = elems.length; _i < _len; _i++) {
      $elem = elems[_i];
      $elem.on("mouseover", function() {
        return showHover(item);
      });
      _results.push($elem.on("mouseout", function() {
        return hideHover(item);
      }));
    }
    return _results;
  };

}).call(this);
